 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/backend/src/main/java/com/grindsup/backend/service/UserService.java b/backend/src/main/java/com/grindsup/backend/service/UserService.java
index e062c44c570e01fa25dc56f428179366229423e2..b7447f8733adbf78bd953510bda85cac77cc6c34 100644
--- a/backend/src/main/java/com/grindsup/backend/service/UserService.java
+++ b/backend/src/main/java/com/grindsup/backend/service/UserService.java
@@ -1,53 +1,102 @@
 package com.grindsup.backend.service;
 
 import com.google.api.client.googleapis.auth.oauth2.GoogleClientSecrets;
+import com.grindsup.backend.model.Usuario;
+import com.grindsup.backend.repository.UsuarioRepository;
 import org.springframework.stereotype.Service;
 
 import java.util.HashMap;
 import java.util.Map;
+import java.util.Optional;
 
 @Service
 public class UserService {
 
     // Simulación de base de datos en memoria (se borra al reiniciar)
     private final Map<String, String> userRefreshTokens = new HashMap<>();
     private GoogleClientSecrets clientSecrets; // Asumimos que se configura externamente
+    private final UsuarioRepository usuarioRepository;
+
+    public UserService(UsuarioRepository usuarioRepository) {
+        this.usuarioRepository = usuarioRepository;
+    }
 
     /**
      * Devuelve el refresh token de un usuario por su ID.
      * ⚠️ Nota: Esta simulación en memoria se limpia al reiniciar el servidor.
      * * @param userId ID del usuario (debe coincidir con la clave de guardado, ej: "4")
      * @return refresh token o null si no existe.
      */
     public String getRefreshTokenForUser(String userId) {
         // Devuelve el token si existe, o null. Esto evita el crash.
         String token = userRefreshTokens.get(userId);
-        if (token == null) {
-            // Log para diagnóstico: si no encuentra la clave, es porque el Map está vacío o la clave no coincide.
+        if (token != null && !token.isBlank()) {
+            return token;
+        }
+
+        Optional<Usuario> usuarioOpt = resolveUsuario(userId);
+        if (usuarioOpt.isEmpty()) {
+            System.err.println("❌ ERROR AUTH: Usuario NO encontrado para userId: " + userId);
+            return null;
+        }
+
+        String persistedToken = usuarioOpt.get().getGoogleRefreshToken();
+        if (persistedToken == null || persistedToken.isBlank()) {
             System.err.println("❌ ERROR AUTH: Refresh Token NO encontrado para userId: " + userId);
+            return null;
         }
-        return token;
+
+        // Cachear para siguientes llamadas en esta ejecución
+        userRefreshTokens.put(userId, persistedToken);
+        return persistedToken;
     }
 
     /**
      * Guarda o actualiza el refresh token de un usuario.
      * * @param userId ID del usuario (clave: ej. "4")
      * @param refreshToken refresh token de Google
      */
     public void setRefreshTokenForUser(String userId, String refreshToken) {
+        if (userId == null || userId.isBlank() || refreshToken == null || refreshToken.isBlank()) {
+            return;
+        }
+
         userRefreshTokens.put(userId, refreshToken);
+
+        resolveUsuario(userId).ifPresent(usuario -> {
+            usuario.setGoogleRefreshToken(refreshToken);
+            usuarioRepository.save(usuario);
+        });
+
         System.out.println("✅ Refresh Token guardado para userId: " + userId.trim());
     }
 
+    private Optional<Usuario> resolveUsuario(String userId) {
+        if (userId == null || userId.isBlank()) {
+            return Optional.empty();
+        }
+
+        if (userId.chars().allMatch(Character::isDigit)) {
+            try {
+                Long id = Long.parseLong(userId);
+                return usuarioRepository.findById(id);
+            } catch (NumberFormatException ex) {
+                // Continuar intentando con correo
+            }
+        }
+
+        return usuarioRepository.findByCorreoIgnoreCase(userId);
+    }
+
     // El resto de los métodos se mantienen iguales (get/setClientSecrets)
     public void setClientSecrets(GoogleClientSecrets clientSecrets) {
         this.clientSecrets = clientSecrets;
     }
 
     public GoogleClientSecrets getClientSecrets() {
         if (clientSecrets == null) {
             throw new RuntimeException("Client secrets no configurados");
         }
         return clientSecrets;
     }
 }
\ No newline at end of file
 
EOF
)